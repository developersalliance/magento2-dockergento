version: '3'

services:
    frontend:
        hostname: local.sufeya.com
        build:
            context: ./config/dockerfiles/node
        volumes: &appvolumes-frontend
            - ./.env:/var/www/.env:delegated
        environment:
            VIRTUAL_HOST: local.sufeya.com
            VIRTUAL_PORT: 8080
        expose:
            - 8080

    phpfpm:
        image: devallgento/php:7.4-fpm
        ports:
            - "2222:22"
        volumes: &appvolumes
            - ../.composer:/var/www/.composer:delegated
            - ../.composer:/var/www/html/var/composer_home:delegated
            - ./config/dockergento/nginx/conf/default.conf:/var/www/conf/nginx/default.conf:delegated
        environment:
            PHP_IDE_CONFIG: serverName=localhost
        depends_on:
            - db
        networks:
            - localswarm

    phpfpm_xdebug:
        image: devallgento/php:7.4-fpm
        volumes: *appvolumes
        depends_on:
            - phpfpm
        networks:
            - localswarm

    varnish:
        image: devallgento/varnish
        ports:
            - 8080:80
        depends_on:
            - nginx
        environment:
            - VIRTUAL_PORT=80
        networks:
            - localswarm

    nginx:
        image: modestcoders/nginx:1.13
        ports:
            - 80:8000
        volumes: *appvolumes
        depends_on:
            - phpfpm
            - phpfpm_xdebug
            - mailhog
            - elasticsearch
            - redis
        networks:
            - localswarm

    db:
        image: mysql:8
        hostname: mysql8
        environment:
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: magento
            MYSQL_USER: magento
            MYSQL_PASSWORD: magento
        shm_size: '2gb'
        ports:
            - 3306:3306
        volumes:
            - dbdata:/var/lib/mysql
        networks:
            - localswarm
        command: --default-authentication-plugin=mysql_native_password

    redis:
        image: redis:latest
        networks:
            - localswarm
        volumes:
            - rddata:/data

    mailhog:
        image: mailhog/mailhog
        ports:
            - 1025:1025
            - 8025:8025
        networks:
            - localswarm

    elasticsearch:
        tty: true
        image: elasticsearch:7.7.1
        environment:
            - discovery.type=single-node # may not have an effect
            - xpack.security.enabled=false
            - ELASTIC_USERNAME=username
            - ELASTIC_PASSWORD=password
        ports:
            - 9200:9200
        networks:
            - localswarm
        volumes:
            - esdata:/usr/share/elasticsearch/data

    kibana:
        image: kibana:7.7.1
        ports:
            - 5601:5601
        environment:
            ELASTICSEARCH_URL: http://elasticsearch:9200
            ELASTICSEARCH_HOSTS: http://elasticsearch:9200
        networks:
            - localswarm

    rabbitmq:
        image: rabbitmq:3-management
        environment:
            - RABBITMQ_DEFAULT_USER=guest
            - RABBITMQ_DEFAULT_PASS=guest
        ports:
            - 15672:15672
            - 5672:5672
        networks:
            - localswarm

volumes:
    dbdata:
    rddata:
    esdata:

networks:
    localswarm:
